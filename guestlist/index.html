<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guest List</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <style>
  #total-guests {
    font-size: 17px;
  }

  .email-list {
    display: none;
    word-wrap: break-word;
    padding: 5px;
    background-color: #F9F9F9;
    border: 1px solid #eee;
  }

  </style>
</head>
<body>

  <div class="container">

    <div>
      <a href="http://francowedding.rsvpug.com/">back to site</a>
    </div>

    <div class="login-page">
      <h1>Admin</h1>
      <form class="admin-form">
        <div class="form-group">
          <input type="password" class="admin-password form-control">
        </div>
        <div class="form-group">
          <button type="submit" class="btn">login</button>
        </div>
      </form>
    </div>

    <div class="guest-list hide">
      <h1>Guest List</h1>
      <div id="total-guests">Total guests: <span class="total"></span></div>
      <div>
        <a href="#" class="email-list-toggle">email list <i class="email-list-icon glyphicon glyphicon-chevron-up"></i></a>
        <div class="email-list">
          <p></p>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <td><strong>#</strong></td>
              <td><strong>First Name</strong></td>
              <td><strong>Last Name</strong></td>
              <td><strong>Email</strong></td>
              <td><strong>RSVP</strong></td>
              <td><strong>Plus One</strong></td>
              <td><strong>Message</strong></td>
            </tr>
          </thead>
          <tbody id="guestlist"></tbody>
        </table>
      </div>
      <span class="loading">loading...</span>
    </div>
  </div>

  <script type="text/x-handlebars-template" id="guestlist-tmpl">
  {{#each guests}}
  <tr>
    <td>{{@index}}</td>
    <td>{{doc.first_name}}</td>
    <td>{{doc.last_name}}</td>
    <td>{{doc.email}}</td>
    <td>{{doc.reservation}}</td>
    <td>{{doc.plus_one}}</td>
    <td>{{doc.message}}</td>
  </tr>
  {{/each}}
  </script>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
  <script>
  (function ($) {

    $(document).ready(main);

    function main () {
      var store = 'fw_login';

      if(getStore(store) === "true") {
        renderGuestList();
      }

      $('.admin-form').on('submit', function (e) {
        e.preventDefault();
        if ($('.admin-password').val() === 'wedding') {
          setStore(store, true);
          return renderGuestList();
        }
      });

      $('.email-list-toggle').on('click', function (e) {
        e.preventDefault();

        $('.email-list-icon').toggleClass('glyphicon-chevron-up')
        $('.email-list-icon').toggleClass('glyphicon-chevron-down')
        $('.email-list').slideToggle();
      });

    }

    function setStore(k, v) {
      if (!localStorage) return null;
      return localStorage.setItem(k,v);
    }

    function getStore (k) {
      if (!localStorage) return null;
      return localStorage.getItem(k);
    }

    function renderGuestList () {
      $('.login-page').addClass('hide');
      $('.guest-list').removeClass('hide');
      guestList();
    }

    function guestList() {

      //https://jesuswedding.iriscouch.com/weddingrsvp/_all_docs?include_docs=true

      $.ajax({
        url: "https://paulserraino.cloudant.com/jesuswedding/_all_docs?include_docs=true",
        type: "GET",
        dataType: "jsonp"
      }).done(function (data) {
        $(".loading").remove();

        var count = data.rows.reduce(function (a, b) {
          var p = b.doc.plus_one;
          var re = /no/gi;
          if(p && !re.test(p)) return a + 1;
          return a;
        }, data.total_rows );

        $('.total').text(count);

        var emails = data.rows.map(function (r) { return r.doc.email; });

        $('.email-list p').html(emails.join(', ' ));

        var tmpl = Handlebars.compile($("#guestlist-tmpl").html());
        $("#guestlist").html(tmpl({ guests: data.rows }));
      });

    }

  })(jQuery);
  </script>
</body>
</html>
